From ae8c3358a84733b5edf0c78ec505d57eee864963 Mon Sep 17 00:00:00 2001
From: Emanuele Parisi <emanuele.parisi@protonmail.com>
Date: Wed, 6 Sep 2023 19:04:34 +0200
Subject: [PATCH 1/2] Resolve data races for self-invalidation coherence

---
 arch/riscv/include/asm/processor.h      | 1 +
 arch/riscv/include/asm/vdso/processor.h | 1 +
 arch/riscv/kernel/head.S                | 1 +
 3 files changed, 3 insertions(+)

diff --git a/arch/riscv/include/asm/processor.h b/arch/riscv/include/asm/processor.h
index bdddcd5c1b71..33354bd0d584 100644
--- a/arch/riscv/include/asm/processor.h
+++ b/arch/riscv/include/asm/processor.h
@@ -62,6 +62,7 @@ extern unsigned long get_wchan(struct task_struct *p);
 
 static inline void wait_for_interrupt(void)
 {
+	__smp_mb();
 	__asm__ __volatile__ ("wfi");
 }
 
diff --git a/arch/riscv/include/asm/vdso/processor.h b/arch/riscv/include/asm/vdso/processor.h
index 134388cbaaa1..b0a15ca5d933 100644
--- a/arch/riscv/include/asm/vdso/processor.h
+++ b/arch/riscv/include/asm/vdso/processor.h
@@ -8,6 +8,7 @@
 
 static inline void cpu_relax(void)
 {
+	__smp_mb();
 #ifdef __riscv_muldiv
 	int dummy;
 	/* In lieu of a halt instruction, induce a long-latency stall. */
diff --git a/arch/riscv/kernel/head.S b/arch/riscv/kernel/head.S
index 7e849797c9c3..9d655a07ca22 100644
--- a/arch/riscv/kernel/head.S
+++ b/arch/riscv/kernel/head.S
@@ -299,6 +299,7 @@ clear_bss_done:
 	 */
 .Lwait_for_cpu_up:
 	/* FIXME: We should WFI to save some energy here. */
+	fence
 	REG_L sp, (a1)
 	REG_L tp, (a2)
 	beqz sp, .Lwait_for_cpu_up
-- 
2.30.2

